@if (step === 'lobby') {
<div class="bg-[#272B30] flex flex-col font-sans selection:bg-[#6834FF] selection:text-white p-4 gap-4 h-screen">

    <nav class="relative z-50 flex justify-between items-center bg-[#1E1E1E] rounded-md px-4 py-2 h-16 shrink-0">
        <div class="flex items-center gap-3">
            <img src="/ib-logo.png" alt="Interview Buddy" class="h-8 w-auto">
        </div>
        <div class="flex items-center gap-2">
            <img src="/headset-f.png" alt="Support" class="w-5 h-5">
        </div>
    </nav>


    <div class="bg-[#1E2024] rounded-lg border border-white/5 p-6 animate-fade-in shrink-0">
        <h1 class="text-white text-lg font-medium mb-6">
            Hi {{name}}, Welcome to your <span class="text-white">{{title}}</span>
        </h1>

        <div class="grid grid-cols-2 md:grid-cols-5 gap-6 md:gap-4 border-t border-white/10 pt-6">
            <div class="flex flex-col gap-1.5">
                <span class="text-xs text-gray-400 font-medium uppercase tracking-wide">Title</span>
                <span class="text-sm text-gray-200 font-semibold">{{details.role}}</span>
            </div>

            <div class="flex flex-col gap-1.5">
                <span class="text-xs text-gray-400 font-medium uppercase tracking-wide">Experience</span>
                <span class="text-sm text-gray-200 font-semibold">{{details.experience}}</span>
            </div>

            <div class="flex flex-col gap-1.5">
                <span class="text-xs text-gray-400 font-medium uppercase tracking-wide">Attempts per question</span>
                <span class="text-sm text-gray-200 font-semibold">{{details.attempts}}</span>
            </div>

            <div class="flex flex-col gap-1.5">
                <span class="text-xs text-gray-400 font-medium uppercase tracking-wide">Total question</span>
                <span class="text-sm text-gray-200 font-semibold">{{details.totalQuestions}}</span>
            </div>

            <div class="flex flex-col gap-1.5">
                <span class="text-xs text-gray-400 font-medium uppercase tracking-wide">Duration per question</span>
                <span class="text-sm text-gray-200 font-semibold">{{details.duration}}</span>
            </div>
        </div>
    </div>



    <div
        class="flex-1 bg-[#23262B] rounded-lg border border-white/5 p-6 flex flex-col animate-fade-in delay-100 min-h-0">
        <h2 class="text-lg font-medium text-white mb-4">Instructions</h2>

        <div class=" pr-2 custom-scrollbar flex-1">
            <ul class="space-y-2 text-sm text-gray-300 list-disc pl-4 marker:text-gray-500">
                <li>Test your audio and video. Adjust the settings if necessary.</li>
                <li>Sit in a well-lit area with your face clearly visible and no background noise.</li>
                <li>Avoid having moving objects in the background.</li>
                <li>Maintain a stable internet connection.</li>
                <li>Ensure your device is charged or plugged in to avoid any interruptions.</li>
                <li>Please remain in the meeting room for at least 10 minutes. This time is necessary to capture your
                    attendance, so stay even if the other person has not yet attended.</li>
                <li>The whiteboard in the meeting room works both ways; any changes you make are visible to the other
                    person.</li>
                <li>The code console is limited to your end. Please share your screen to show your code console to the
                    other person.</li>
                <li>Keep an eye on the time, you will be prompted 2 minutes before the meeting ends.</li>
            </ul>
        </div>


        <div class="flex flex-col sm:flex-row items-center justify-between pt-6 md:pt-12 border-t border-white/5 mt-4">
            <div class="flex items-center gap-3">
                <div class="relative flex items-center">
                    <input type="checkbox" [(ngModel)]="isAgreed" id="instructions-agree"
                        class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-gray-600 bg-[#2A2D32] checked:border-[#6834FF] checked:bg-[#6834FF] transition-all">
                    <svg class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 pointer-events-none opacity-0 peer-checked:opacity-100 text-white transition-opacity"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                </div>
                <label for="instructions-agree" class="text-sm text-gray-300 cursor-pointer select-none">
                    I have read and understood all instructions
                </label>
            </div>

            <button (click)="handleNext()" [disabled]="!isAgreed"
                class="px-8 py-2.5 text-brand-500 bg-brand-50 font-medium rounded-md disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 transition-colors w-full sm:w-auto mt-4 sm:mt-0">
                Next
            </button>
        </div>
    </div>
</div>
}


@else {
<!-- System Checks View -->
<div class="bg-[#272B30] p-3 flex flex-col items-center gap-5 min-h-screen">

    <div class="w-full shrink-0">
        <nav class=" bg-[#1E1E1E] flex h-[68px] px-4 justify-between items-center rounded-md ">
            <div class="flex items-center gap-3">
                <img src="/ib-logo.png" alt="Interview Buddy" class="h-8 w-auto">
            </div>
            <div class="flex items-center gap-2">
                <img src="/headset-f.png" alt="Support" class="w-5 h-5">
            </div>
        </nav>
    </div>

    <!-- main     -->
    <div class="w-full flex items-stretch gap-5 flex-wrap lg:flex-nowrap flex-1 min-h-0">

        <!-- Left-->
        <div class="bg-[#1E1E1E] flex-1 min-w-[300px] flex rounded-md flex-col">

            <div class="flex flex-col items-start flex-1 self-stretch h-full gap-0">

                <div class="relative w-full aspect-video bg-black rounded-md overflow-hidden shadow-2xl shrink-0 group">

                    <video #videoElement autoplay playsinline class="w-full h-full object-cover transform scale-x-[-1]"
                        [muted]="!isPlaying">
                    </video>

                    @if (!stream && !errorMessage) {
                    <div class="absolute inset-0 flex items-center justify-center bg-[#1E2024]">
                        <div class="w-8 h-8 rounded-full border-2 border-[#6834FF] border-t-transparent animate-spin">
                        </div>
                    </div>
                    }

                    @if (errorMessage) {
                    <div class="absolute inset-0 flex items-center justify-center bg-[#1E2024] p-4 text-center">
                        <p class="text-red-400 text-sm">{{ errorMessage }}</p>
                    </div>
                    }

                    @if (stream) {

                    @if (testState === 'completed' && !isPlaying) {
                    <div class="absolute inset-0 flex items-center justify-center z-10">
                        <button (click)="playRecording()"
                            class="transform transition-transform hover:scale-110 focus:outline-none">
                            <img src="/video-play-button.svg" alt="Play" class="w-20 h-20 opacity-90 hover:opacity-100">
                        </button>
                    </div>
                    }

                    <div
                        class="absolute bottom-2 md:bottom-2 left-1/2 -translate-x-1/2 flex items-center gap-3 md:gap-4 z-20">

                        @if (testState === 'idle') {
                        <button (click)="startRecording()"
                            class="bg-brand-50 px-6 py-2.5 text-brand-500 text-sm rounded-full border-8 border-[rgba(11,19,49,0.6)]">
                            Test
                        </button>
                        }
                        @else if (testState === 'running') {
                        <button (click)="stopRecordingAndCheck()"
                            class="px-6 py-2.5 bg-red-100 text-red-500 text-sm font-semibold rounded-full border-8 border-[rgba(11,19,49,0.6)] flex items-center gap-2">
                            Stop
                            <div class=" border-2 border-red-500 rounded-full w-4 h-4 flex items-center justify-center">
                                <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                            </div>
                        </button>
                        }
                        @else if (testState === 'completed') {
                        <button (click)="tryAgain()"
                            class="px-6 py-2.5  text-brand-500 bg-brand-50 text-sm font-semibold shadow-lg flex items-center gap-2  rounded-full border-8 border-[rgba(11,19,49,0.6)]">
                            Try again
                        </button>
                        }
                    </div>
                    }
                </div>

                <!-- Settings -->
                <div
                    class="flex flex-col gap-1.5 p-1 sm:p-3 items-start content-start self-stretch flex-wrap rounded-b-md bg-dark-card">

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full">

                        <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium ml-1">Speakers</label>
                            <div class="relative">
                                <select [ngModel]="selectedSpeaker" (ngModelChange)="onDeviceChange('speaker', $event)"
                                    class="w-full bg-[#272B30] text-sm text-gray-200 rounded-lg px-4 py-3 border border-white/5 focus:border-[#6834FF] focus:outline-none appearance-none cursor-pointer hover:bg-[#2A2D32] transition-colors">
                                    <option *ngFor="let device of audioOutputDevices; let i = index"
                                        [value]="device.deviceId">
                                        {{ device.label || 'Speaker ' + (i + 1) }}
                                    </option>
                                    <option *ngIf="audioOutputDevices.length === 0" value="default">Default Speaker
                                    </option>
                                </select>
                                <div
                                    class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium ml-1">Microphone</label>
                            <div class="relative">
                                <select [ngModel]="selectedMic" (ngModelChange)="onDeviceChange('mic', $event)"
                                    class="w-full bg-[#272B30] text-sm text-gray-200 rounded-lg px-4 py-3 border border-white/5 focus:border-[#6834FF] focus:outline-none appearance-none cursor-pointer hover:bg-[#2A2D32] transition-colors">
                                    <option *ngFor="let device of audioInputDevices; let i = index"
                                        [value]="device.deviceId">
                                        {{ device.label || 'Microphone ' + (i + 1) }}
                                    </option>
                                    <option *ngIf="audioInputDevices.length === 0" value="default">Default Microphone
                                    </option>
                                </select>
                                <div
                                    class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium ml-1">Camera</label>
                            <div class="relative">
                                <select [ngModel]="selectedCamera" (ngModelChange)="onDeviceChange('camera', $event)"
                                    class="w-full bg-[#272B30] text-sm text-gray-200 rounded-lg px-4 py-3 border border-white/5 focus:border-[#6834FF] focus:outline-none appearance-none cursor-pointer hover:bg-[#2A2D32] transition-colors">
                                    <option *ngFor="let device of videoInputDevices; let i = index"
                                        [value]="device.deviceId">
                                        {{ device.label || 'Camera ' + (i + 1) }}
                                    </option>
                                    <option *ngIf="videoInputDevices.length === 0" value="default">Default Camera
                                    </option>
                                </select>
                                <div
                                    class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-xs text-gray-400 font-medium ml-1">Enhancements</label>
                            <div class="flex gap-1.5 h-[46px]">
                                <button (click)="toggleBlur()" [class.bg-[#2A2D32]]="!blurEnabled"
                                    [class.bg-[#3D4045]]="blurEnabled"
                                    class="flex-1 flex items-center justify-center gap-2 px-3 rounded-lg text-sm font-medium transition-all border border-white/5 hover:bg-[#32363C] text-gray-300 h-full">
                                    <img src="blur.svg" alt="">
                                    Background Blur
                                </button>

                                <button (click)="toggleNoiseCancellation()"
                                    [class.bg-[#2A2D32]]="!noiseCancellationEnabled"
                                    [class.bg-[#3D4045]]="noiseCancellationEnabled"
                                    class="flex-1 flex items-center justify-center gap-2 px-3 rounded-lg text-sm font-medium transition-all border border-white/5 hover:bg-[#32363C] text-gray-300 h-full">
                                    <img src="noice.svg" alt="">
                                    Noise Cancellation
                                </button>
                            </div>
                        </div>
                        <canvas #canvasElement style="display: none;"></canvas>
                    </div>

                    @if(testState === 'idle') {
                    <div class="flex w-full p-2 flex-col items-start gap-2 rounded-md border border-blue-500 bg-white">
                        <div class="flex items-start gap-2 self-stretch">
                            <img src="information-circle.svg" alt="">
                            <p class="flex-1 text-black font-normal text-xs leading-5">Please use the built-in noise
                                cancellation on Mac and iOS devices.</p>
                        </div>
                    </div>
                    }
                </div>
            </div>
        </div>

        <!-- Right -->
        <div class="flex-1 min-w-[300px] flex bg-[#1E1E1E] rounded-md">

            <div class="flex w-full p-3 flex-col items-start gap-3 rounded-md bg-dark-card h-full justify-between">

                <div class="flex items-center gap-4 self-stretch">
                    <h2 class="flex-1 text-white font-semibold text-xl leading-7">Quick check</h2>
                </div>


                <div class="flex flex-col items-start gap-6 flex-1 self-stretch pt-2">

                    @if (testState === 'idle' || testState === 'running') {

                    <div class="flex items-start gap-2 self-stretch">
                        <div class="flex flex-col justify-center items-start flex-1">
                            <p class="self-stretch text-white text-lg leading-7">
                                <span class="font-normal">When you're ready, click Start </span>
                                <span class="font-semibold">Test</span>
                                <span class="font-normal"> and then read the words on screen out loud.</span>
                            </p>
                        </div>
                    </div>


                    <div class="flex items-start gap-2 self-stretch">
                        <div class="flex flex-col justify-center items-start flex-1">
                            <div class="self-stretch text-white leading-7">
                                <span class="font-normal text-lg">Test words:
                                </span>
                                <span class="font-semibold text-xl italic text-gray-300 block mt-2">"Hello, I am
                                    checking my microphone and camera to
                                    make sure everything is working properly before the session begins."</span>
                            </div>
                        </div>
                    </div>
                    } @else if (testState === 'analyzing') {
                    <div class="flex flex-col gap-6 w-full">
                        <div class="flex gap-4 items-start">
                            <div class="mt-1">
                                @if(cameraStatus === 'pending' || cameraStatus === 'checking') {
                                <img src="/refresh-icon.svg" alt="Checking" class="w-5 h-5 animate-spin">
                                } @else if(cameraStatus === 'success') {
                                <img src="/checkmark-icon.svg" alt="Success" class="w-5 h-5">
                                } @else {
                                <div
                                    class="w-5 h-5 rounded-full border-2 border-red-500 flex items-center justify-center text-red-500">
                                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                        stroke-width="3">
                                        <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>
                                }
                            </div>
                            <div>
                                <h3 class="text-white font-medium mb-1">Camera</h3>
                                <p class="text-sm text-gray-400">
                                    @if(cameraStatus === 'checking') { Checking... }
                                    @else if(cameraStatus === 'success') { Camera is working well. }
                                    @else if(cameraStatus === 'failure') { Camera access failed. }
                                    @else { Waiting... }
                                </p>
                            </div>
                        </div>

                        <div class="flex gap-4 items-start">
                            <div class="mt-1">
                                @if(micStatus === 'pending') {
                                <div class="w-5 h-5 rounded-full border-2 border-gray-700"></div>
                                } @else if(micStatus === 'checking') {
                                <img src="/refresh-icon.svg" alt="Checking" class="w-5 h-5 animate-spin">
                                } @else if(micStatus === 'success') {
                                <img src="/checkmark-icon.svg" alt="Success" class="w-5 h-5">
                                }
                            </div>
                            <div>
                                <h3 class="text-white font-medium mb-1">Microphone</h3>
                                <p class="text-sm text-gray-400">
                                    @if(micStatus === 'checking') { Checking... }
                                    @else if(micStatus === 'success') { Mic is functioning properly. }
                                    @else { Waiting... }
                                </p>
                            </div>
                        </div>

                        <div class="flex gap-4 items-start">
                            <div class="mt-1">
                                @if(networkStatus === 'pending') {
                                <div class="w-5 h-5 rounded-full border-2 border-gray-700"></div>
                                } @else if(networkStatus === 'checking') {
                                <img src="/refresh-icon.svg" alt="Checking" class="w-5 h-5 animate-spin">
                                } @else if(networkStatus === 'success') {
                                <img src="/checkmark-icon.svg" alt="Success" class="w-5 h-5">
                                }
                            </div>
                            <div>
                                <h3 class="text-white font-medium mb-1">Network</h3>
                                <p class="text-sm text-gray-400">
                                    @if(networkStatus === 'checking') { Checking... }
                                    @else if(networkStatus === 'success') { Network connection is stable. }
                                    @else { Waiting... }
                                </p>
                            </div>
                        </div>
                    </div>
                    } @else {

                    <div class="flex flex-col gap-6 w-full">


                        <div class="flex gap-4 items-start">
                            <div class="mt-1">
                                @if(cameraStatus === 'success') {
                                <img src="/camera-check.svg" alt="Success" class="w-5 h-5">
                                } @else {
                                <div
                                    class="w-5 h-5 rounded-full border-2 border-red-500 flex items-center justify-center text-red-500">
                                    <svg class="w-2.5 h-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                        stroke-width="3">
                                        <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>
                                }
                            </div>
                            <div>
                                <h3 class="text-white font-medium mb-1">Camera</h3>
                                @if(cameraStatus === 'success') {
                                <p class="text-sm text-gray-400">Camera is working well. You're clearly visible.</p>
                                } @else {
                                <p class="text-sm text-red-500">Camera access failed.</p>
                                }
                            </div>
                        </div>


                        <div class="flex gap-4 items-start">
                            <div class="mt-1">
                                @if(micStatus === 'success') {
                                <img src="/signal-check.svg" alt="Success" class="w-5 h-5">
                                } @else {
                                <div
                                    class="w-5 h-5 rounded-full border-2 border-red-500 flex items-center justify-center text-red-500">
                                    <svg class="w-2.5 h-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                        stroke-width="3">
                                        <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>
                                }
                            </div>
                            <div>
                                <h3 class="text-white font-medium mb-1">Microphone</h3>
                                @if(micStatus === 'success') {
                                <p class="text-sm text-gray-400">Mic is functioning properly. Your voice is clear.</p>
                                } @else {
                                <p class="text-sm text-red-500">Microphone check failed.</p>
                                }
                            </div>
                        </div>


                        <div class="flex gap-4 items-start">
                            <div class="mt-1">
                                @if(networkStatus === 'success') {
                                <img src="/network-check.svg" alt="Success" class="w-5 h-5">
                                } @else {
                                <div
                                    class="w-5 h-5 rounded-full border-2 border-red-500 flex items-center justify-center text-red-500">
                                    <svg class="w-2.5 h-2.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                                        stroke-width="3">
                                        <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>
                                }
                            </div>
                            <div>
                                <h3 class="text-white font-medium mb-1">Network</h3>
                                @if(networkStatus === 'success') {
                                <p class="text-sm text-gray-400">Network quality is good.</p>
                                } @else {
                                <p class="text-sm text-red-500">Network check failed.</p>
                                }
                            </div>
                        </div>
                    </div>
                    }
                </div>


                <div class="flex flex-col gap-4 self-stretch">

                    @if(testState === 'completed' && allChecksPassed) {
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="acknowledge" [(ngModel)]="isAcknowledged"
                            class="w-4 h-4 rounded border-gray-600 bg-[#272B30] text-[#6834FF] focus:ring-[#6834FF]">
                        <label for="acknowledge" class="text-sm text-gray-300 cursor-pointer select-none">
                            I acknowledge that my setup has been tested properly.
                        </label>
                    </div>
                    }


                    <div class="flex flex-col justify-center items-end gap-2.5 self-stretch">
                        <button (click)="joinMeeting()" [disabled]="!allChecksPassed || !isAcknowledged"
                            [class.opacity-40]="!allChecksPassed || !isAcknowledged"
                            [class.cursor-not-allowed]="testState !== 'completed' || !isAcknowledged"
                            class="flex h-8 px-4 py-2.5 justify-center items-center gap-1 rounded-md bg-brand-50 transition-opacity">
                            <span class="text-brand-500 font-normal text-xs leading-5">Join</span>
                            <svg class="w-3 h-3" width="12" height="12" viewBox="0 0 12 12" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M3.59998 10.8L7.69287 6.70706C8.0262 6.37372 8.19287 6.20706 8.19287 5.99995C8.19287 5.79284 8.0262 5.62618 7.69287 5.29284L3.59998 1.19995"
                                    stroke="#6834FF" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
}

<app-permission-modal [visible]="permissionDenied"></app-permission-modal>